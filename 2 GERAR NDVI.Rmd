---
title: "NDVI (versão 1)"
author: "Igor Viana Souza"
date: "14/12/2021"
output:
  html_document: default
  pdf_document: default
---

### 1. Introdução

O documento tem como propósito auxiliar no entendimento do *script* na geração de imagens NDVIs e RGBs. A sua principal função é automatizar alguns processos repetitivos durante a geração dos produtos, tais como: leitura de arquivos, recortes, cálculo do NDVI e exportação dos produtos gerados.

### 2. Importação das bibliotecas

Os pacotes são conjunto de funções que nos auxiliarão a desenvolver um determinado resultado. Boa parte desses pacotes podem ser encontrados na base oficial do *R (CRAN)*. Antes de importar as bibliotecas, é importante realizamos uma limpeza na mémoria do R.

```{r }
#Limpar memória
rm(list=ls(all=TRUE))

```

```{r }
# Importando pacotes
library(raster)
library(rgdal)

```

### 3. Carregando diretório

As linhas abaixo, nos permite selecionar o local, no qual, importaremos nossos arquivos e exportaremos o produto final. É de importancia criar uma pasta no diretório no disco C:. Observe abaixo, o caminho de pasta a ser criado.

```{r setup, include=FALSE }
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:/@IGOR/R/")
setwd("C:/@IGOR/R/")
```

### 4. Criando uma lista para armazenar nossos arquivos

Dentro da pasta R criada anteriormente, crie uma pasta chamada RGB, NDVI e TALHAO. Em cada pasta, você deverá colocar as imagens selecionadas e o poligono. Ao executar as linhas abaixo, é observado o que contém armazenado em lista em cada pasta.

```{r }

RGB <- list.files(path="RGB", pattern = ".tif", full.names = TRUE)    
SHP <- list.files(path="TALHAO", pattern = ".shp", full.names = TRUE)
INDICE <- list.files(path="NDVI", pattern = ".tif", full.names = TRUE) 

RGB

SHP

INDICE

```

### 5. Lendo os arquivos em suas respectivas Pastas

#### 5.1 RGB

A executar, todas as imagens da pasta são carregadas para a memória com o repectivos nomes.

```{r }

## Criando um lista vazia para as Imagens RGB

RGB_STACK<-c() 

```

```{r }
## Leitura de todas imagens na Pasta RGB

r_name <- list.files(path="RGB",full.names = F)

for(i in RGB){ RGB_STACK[[i]]<- stack(i)} 

names(RGB_STACK)<- c(r_name)

RGB_STACK

```

#### 5.2 NDVI

```{r }

NDVI_STACK<-c() 

r_name1 <- list.files(path="NDVI",full.names = F)

for(g in INDICE){ 
  NDVI_STACK[[g]]<- stack(g)} 


names(NDVI_STACK)<- c(r_name1)

NDVI_STACK

```

**IMPORTANTE:** Em `bandas<-NDVI_STACK[[1]]` . O número 1, corresponde a ordem da imagem na pasta NDVI. Dessa maneira ao alterar a numeração, por exemplo, para 2, a leitura será do segundo arquivo na pasta, é comum que seja solicitada imagens em datas distintas. No entanto, em nosso exemplo temos somente uma imagem em cada pasta, portanto, a númeração deverá ser 1. O resultado desta ação selecionou a imagem:`S2B_MSIL2A_20211211T134209_N0301_R124_T22KDF_20211211T161405_r8g11b4.tif` . Lembrando que esse número deverá se repetir nas linhas em que for solicitado.

```{r }

bandas<-NDVI_STACK[[1]]

```

#### 5.3 TALHAO

```{r }
TALHAO<-c()                                                           
for(j in SHP){TALHAO[[j]]<- sf::st_read(j)} 

```

### 6. Cálculo do Índice de Diferença Normalizada Para Sentinel (NDVI)

Os números em `sat_ndvi <- (bandas[[1]] - bandas[[3]]) / (bandas[[1]] + bandas[[3]])` corresponde a ordem em que a banda espectral encontra-se na imagem. Logo, o número 1 corresponde a Banda B8 ( Infravermelho próximo) e 3 ( vermelho). o Resultado da expressão matemática, é um índice que varia de -1 a +1.

```{r }

sat_ndvi_list<-list() ## Criando uma lista para armazenar o produto dos cálculos

sat_ndvi <- (bandas[[1]] - bandas[[3]]) / (bandas[[1]] + bandas[[3]])

NDVI_STACK<- stack(sat_ndvi)

NDVI_STACK

```

#### Visualização NDVI

```{r }

plot(sat_ndvi)


```

### 7. Recortes das imagens por talhão.

Após carregar as imagens RGB e a realização do cálculo NDVI. Necessitamos exportar nosso produto final por talhão, com o propósito de realizarmos posteriormente nossa classificação das cores no Qgis. Neste momento é importante a alteração em `dataoutput<-data.frame(data=r_name[1])`, para o número corresponde a imagem que você está utilizando, nesse caso [1]. Esse momento é de extrema importancia, pois a partir desse momento, conseguimos criar um forma pra nomear os arquivos de saída conforme a data da imagem e o talhão.

```{r }

CO<-TALHAO[[1]]

TA<-CO$TALHAO

output <- data.frame(t = TA)


dataoutput<-data.frame(data=r_name[1]) ##ALTERA O NÚMERO, PARA MUDAR A IMAGEM

output

dataoutput

names_data<-paste("RGB_",output$t,dataoutput$data)

LISTA<-list()

```

#### 7.1 Recorte RGB

Mais uma vez precisamos alterar a númeração de `RGB_STACK[[1]]`. Nesse momento é realizado os corte por talhão, sendo armazendo em uma lista `LISTA<-list()` .

```{r }
RGB_STACK
for (c in 1:length(output$t)) {LISTA[c]<- mask(RGB_STACK[[1]], CO[CO$TALHAO==output$t[c],])
 
}
 names(LISTA)<- c(names_data)
 LISTA
```

Apesar das várias mensagens de "Warning in"(Somente um alerta), O processo foi executado com sucesso.

#### 7.2 Recorte NDVI

Agora repetindo mesmo procedimento para o NDVI.

```{r}
LISTA_NDVI<-list()

for (y in 1:length(output$t)) {LISTA_NDVI[y]<- mask(sat_ndvi, CO[CO$TALHAO==output$t[y],])
}

names_data2<-paste("NDVI_",output$t,dataoutput$data)
names(LISTA_NDVI)<- c(names_data2)
LISTA_NDVI
```

### 8. EXPORTANDO PRODUTOS

Por fim, exportaremos nossos produtos

```{r}
mapply(writeRaster, LISTA, names(LISTA), 'GTiff',overwrite= TRUE)
mapply(writeRaster, LISTA_NDVI, names(LISTA_NDVI), 'GTiff', overwrite= TRUE)

```
